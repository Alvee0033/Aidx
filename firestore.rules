rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isOwnerOrUserField() {
      return isAuthenticated() && (
        request.auth.uid == resource.data.userId
      );
    }
    
    function isCreateByOwner() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Users collection - users can only access their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // User profiles collection - public read, owner write
    match /user_profiles/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // Health data collection - users can only access their own health data
    match /health_data/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Watch control collection - users can only access their own watch data
    match /watch_control/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Medications collection - users can only access their own medications
    match /medications/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Appointments collection - users can only access their own appointments
    match /appointments/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Reminders collection - users can only access their own reminders
    match /reminders/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Symptoms collection - users can only access their own symptoms
    match /symptoms/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }

    // Symptom records subcollection - users can only access their own symptom records
    match /users/{userId}/symptomRecords/{document} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // Emergency contacts collection - users can only access their own contacts
    match /emergency_contacts/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Wearable data collection - users can only access their own wearable data
    match /wearable_data/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Health habits collection - users can only access their own habits
    match /health_habits/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Habit badges collection - users can only access their own badges
    match /habit_badges/{document} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isCreateByOwner();
      allow update, delete: if isOwnerOrUserField();
    }
    
    // Hospitals collection - public read access for nearby search
    match /hospitals/{document} {
      allow read: if true; // Public read access for hospital search
      allow write: if false; // No write access (admin only)
    }
    
    // Pharmacies collection - public read access for nearby search
    match /pharmacies/{document} {
      allow read: if true; // Public read access for pharmacy search
      allow write: if false; // No write access (admin only)
    }
    
    // Community posts collection - public read, authenticated write
    match /community_posts/{document} {
      allow read: if true; // Public read access for community posts
      allow create: if isCreateByOwner();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        // Allow others to update likes, shares, comments counts
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes', 'likedBy', 'shares', 'comments'])
      );
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Community comments collection - public read, authenticated write
    match /community_comments/{document} {
      allow read: if true; // Public read access for comments
      allow create: if isCreateByOwner();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        // Allow others to update likes
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes', 'likedBy'])
      );
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Direct messages collection - only participants can access
    match /direct_messages/{document} {
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }
    
    // Chat conversations collection - only participants can access
    match /chat_conversations/{document} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow delete: if false; // Don't allow deletion of conversations
    }
    
    // Chats collection - only participants can access
    match /chats/{chatId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow delete: if false; // Don't allow deletion of chats
      
      // Messages subcollection - only participants (sender/receiver) can access
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (
          resource.data.senderId == request.auth.uid ||
          resource.data.receiverId == request.auth.uid
        );
        allow create: if isAuthenticated() && (
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.receiverId != null
        );
        allow update: if isAuthenticated() && (
          resource.data.senderId == request.auth.uid ||
          resource.data.receiverId == request.auth.uid
        );
        allow delete: if false;
      }
    }
    
    // Allow all operations for authenticated users on any other collection
    // This is a fallback for any collections not explicitly defined above
    match /{collection}/{document} {
      allow read, write: if isAuthenticated();
    }
  }
}