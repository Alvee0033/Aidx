rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user owns the document or document has userId field
    function isOwnerOrUserField(userId) {
      return isAuthenticated() && (
        request.auth.uid == userId || 
        request.auth.uid == resource.data.userId
      );
    }
    
    // Users collection - users can only access their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Health data collection - users can only access their own health data
    match /health_data/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Medications collection - users can only access their own medications
    match /medications/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Appointments collection - users can only access their own appointments
    match /appointments/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Reminders collection - users can only access their own reminders
    match /reminders/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Symptoms collection - users can only access their own symptoms
    match /symptoms/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Emergency contacts collection - users can only access their own contacts
    match /emergency_contacts/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Wearable data collection - users can only access their own wearable data
    match /wearable_data/{document} {
      allow read, write: if isOwnerOrUserField(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Hospitals collection - public read access for nearby search
    match /hospitals/{document} {
      allow read: if true; // Public read access for hospital search
      allow write: if false; // No write access (admin only)
    }
    
    // Pharmacies collection - public read access for nearby search
    match /pharmacies/{document} {
      allow read: if true; // Public read access for pharmacy search
      allow write: if false; // No write access (admin only)
    }
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 